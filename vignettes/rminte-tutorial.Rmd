---
title: "Working with rminte: R interface for MINTe malaria intervention emulator"
output: rmarkdown::html_vignette
vignette: >
 %\VignetteIndexEntry{Working with rminte: R interface for MINTe malaria intervention emulator}
 %\VignetteEngine{knitr::rmarkdown}
 %\VignetteEncoding{UTF-8}
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 8,
  fig.height = 5
)

# Set matplotlib to use non-interactive backend before any imports
# This is required for CI/headless environments (Windows/macOS without display)
Sys.setenv(MPLBACKEND = "Agg")
```

# Working with rminte: R interface for MINTe malaria intervention emulator

This vignette walks through how to:

1. Install and load the rminte package
2. Run **single** and **multiple** scenarios with `run_minter_scenarios()`
3. Understand the **outputs** (prevalence, cases, scenario metadata)
4. Explore results using tidyverse tools
5. Visualize results with ggplot2
6. Export results to CSV for further analysis

We treat the ML models as a **black box surrogate** for `malariasimulation`:

- You provide: baseline setting + intervention package(s)
- MINTe returns: predicted prevalence and clinical cases over time

## 1. Installation and Setup

```{r install, eval=FALSE}
# Install rminte (if not already installed)
# devtools::install_local("path/to/rminte")

# The Python minte package will be automatically installed via reticulate
# when you first use the package (via py_require)
```

```{r load-packages, message=FALSE, warning=FALSE}
library(rminte)
library(dplyr)
library(ggplot2)
library(tidyr)
```

```{r check-available}
# Check if minte is available
cat("minte available:", minte_available(), "\n")
```

## 2. What `run_minter_scenarios()` does

At a high level, `run_minter_scenarios()`:

1. **Back-calculates EIR** from current prevalence and interventions using the pre-trained **estiMINT XGBoost** model
2. Builds a **scenario table** with baseline EIR, current and future ITN/IRS/LSM, vector behaviour, resistance & net quality
3. Runs the **neural emulator** to predict:
   - Under-5 daily prevalence trajectories
   - All-age daily clinical incidence trajectories per 1000
4. Returns a results object with:
   - `prevalence` - Data frame of prevalence over time for each scenario
   - `cases` - Data frame of clinical cases over time for each scenario
   - `scenario_meta` - Per-scenario metadata including EIR validity
   - `eir_valid` - TRUE/FALSE flag
   - `benchmarks` - Runtime timings (optional)

## 3. A Single Simple Scenario

Here we run **one** scenario by passing single values (or length-1 vectors).

```{r single-scenario}
# Example: a single scenario
res_one <- run_minter_scenarios(
 scenario_tag = "example_scenario",
 res_use = 0.2,        # current resistance
 py_only = 0.3,        # pyrethroid-only net coverage
 py_pbo = 0.2,         # PBO net coverage
 py_pyrrole = 0.1,     # pyrrole net coverage
 py_ppf = 0.05,        # PPF net coverage
 prev = 0.55,          # current under-5 prevalence at decision time
 Q0 = 0.92,            # proportion of bites indoors
 phi = 0.85,           # proportion of bites while people are in bed
 season = 0,           # 0 = perennial, 1 = strongly seasonal
 irs = 0.4,            # current IRS coverage
 irs_future = 0.4,     # future IRS coverage
 lsm = 0.2,            # future LSM coverage
 routine = 1,          # 1 = routine ITN distribution on
 itn_future = 0.45,    # future ITN coverage
 net_type_future = "py_only"
)

# Print summary
print(res_one)
```

## 4. Understanding the Output Structure

The result object exposes the main outputs as list elements:

- `res_one$prevalence` - Data frame with prevalence over time
- `res_one$cases` - Data frame with clinical cases over time

```{r view-prevalence}
# View first few rows of prevalence
cat("Prevalence (head):\n")
head(res_one$prevalence)
```
```{r view-cases}
# View first few rows of cases
cat("\nCases (head):\n")
head(res_one$cases)
```

```{r view-meta}
# View scenario metadata
cat("\nScenario metadata:\n")
print(res_one$scenario_meta)

cat("\nEIR valid:", res_one$eir_valid, "\n")
```

## 5. Running Multiple Scenarios

Now let's compare several intervention strategies. We'll create scenarios for:

- No intervention (baseline)
- IRS only
- LSM only
- Different net types (py_only, py_pbo, py_pyrrole, py_ppf)
- Combinations with LSM

```{r multiple-scenarios}
# Define multiple scenarios
scenarios <- list(
 list(tag = "no_intervention", irs = 0.0, irs_future = 0.0, lsm = 0.0,
      py_only = 0.3, py_pbo = 0.2, py_pyrrole = 0.1, py_ppf = 0.05),
 list(tag = "irs_only", irs = 0.5, irs_future = 0.5, lsm = 0.0,
      py_only = 0.3, py_pbo = 0.2, py_pyrrole = 0.1, py_ppf = 0.05),
 list(tag = "lsm_only", irs = 0.0, irs_future = 0.0, lsm = 0.3,
      py_only = 0.3, py_pbo = 0.2, py_pyrrole = 0.1, py_ppf = 0.05),
 list(tag = "py_only_only", irs = 0.0, irs_future = 0.0, lsm = 0.0,
      py_only = 0.5, py_pbo = 0.0, py_pyrrole = 0.0, py_ppf = 0.0),
 list(tag = "py_only_with_lsm", irs = 0.0, irs_future = 0.0, lsm = 0.3,
      py_only = 0.5, py_pbo = 0.0, py_pyrrole = 0.0, py_ppf = 0.0),
 list(tag = "py_pbo_only", irs = 0.0, irs_future = 0.0, lsm = 0.0,
      py_only = 0.0, py_pbo = 0.5, py_pyrrole = 0.0, py_ppf = 0.0),
 list(tag = "py_pbo_with_lsm", irs = 0.0, irs_future = 0.0, lsm = 0.3,
      py_only = 0.0, py_pbo = 0.5, py_pyrrole = 0.0, py_ppf = 0.0),
 list(tag = "py_ppf_only", irs = 0.0, irs_future = 0.0, lsm = 0.0,
      py_only = 0.0, py_pbo = 0.0, py_pyrrole = 0.0, py_ppf = 0.5),
 list(tag = "py_ppf_with_lsm", irs = 0.0, irs_future = 0.0, lsm = 0.3,
      py_only = 0.0, py_pbo = 0.0, py_pyrrole = 0.0, py_ppf = 0.5),
 list(tag = "py_pyrrole_only", irs = 0.0, irs_future = 0.0, lsm = 0.0,
      py_only = 0.0, py_pbo = 0.0, py_pyrrole = 0.5, py_ppf = 0.0),
 list(tag = "py_pyrrole_with_lsm", irs = 0.0, irs_future = 0.0, lsm = 0.3,
      py_only = 0.0, py_pbo = 0.0, py_pyrrole = 0.5, py_ppf = 0.0)
)

n <- length(scenarios)

# Extract vectors for each parameter
res_multi <- run_minter_scenarios(
 scenario_tag = sapply(scenarios, `[[`, "tag"),
 res_use = rep(0.2, n),
 py_only = sapply(scenarios, `[[`, "py_only"),
 py_pbo = sapply(scenarios, `[[`, "py_pbo"),
 py_pyrrole = sapply(scenarios, `[[`, "py_pyrrole"),
 py_ppf = sapply(scenarios, `[[`, "py_ppf"),
 prev = rep(0.55, n),
 Q0 = rep(0.92, n),
 phi = rep(0.85, n),
 season = rep(0, n),
 irs = sapply(scenarios, `[[`, "irs"),
 irs_future = sapply(scenarios, `[[`, "irs_future"),
 lsm = sapply(scenarios, `[[`, "lsm"),
 routine = rep(1, n),
 benchmark = TRUE
)

print(res_multi)
```

## 6. Exploring Results with dplyr

Let's use tidyverse tools to analyze the results.

```{r explore-prevalence}
# First few rows by scenario
res_multi$prevalence %>%
 group_by(scenario_tag) %>%
 slice_head(n = 3) %>%
 print(n = 20)
```

```{r mean-prevalence}
# Mean prevalence over all timesteps by scenario
mean_prev <- res_multi$prevalence %>%
 group_by(scenario_tag) %>%
 summarise(mean_prevalence = mean(prevalence, na.rm = TRUE)) %>%
 arrange(mean_prevalence)

cat("\nMean prevalence by scenario (sorted):\n")
print(mean_prev)
```

```{r mean-cases}
# Mean cases by scenario
mean_cases <- res_multi$cases %>%
 group_by(scenario_tag) %>%
 summarise(mean_cases = mean(cases, na.rm = TRUE)) %>%
 arrange(mean_cases)

cat("\nMean cases by scenario (sorted):\n")
print(mean_cases)
```

## 7. Visualization with ggplot2

### Prevalence Over Time (All Scenarios)

```{r plot-prevalence-all, fig.width=10, fig.height=6}
ggplot(res_multi$prevalence, aes(x = timestep, y = prevalence, 
                                  color = scenario_tag)) +
 geom_line(linewidth = 0.8, alpha = 0.8) +
 labs(
   title = "Malaria Prevalence Over Time by Intervention Strategy",
   subtitle = "Under-5 prevalence predicted by MINTe neural emulator",
   x = "Timestep (14-day periods)",
   y = "Prevalence",
   color = "Scenario"
 ) +
 theme_minimal() +
 theme(legend.position = "right") +
 scale_color_viridis_d()
```

### Cases Over Time (All Scenarios)

```{r plot-cases-all, fig.width=10, fig.height=6}
ggplot(res_multi$cases, aes(x = timestep, y = cases, 
                             color = scenario_tag)) +
 geom_line(linewidth = 0.8, alpha = 0.8) +
 labs(
   title = "Clinical Cases Over Time by Intervention Strategy",
   subtitle = "Cases per 1000 predicted by MINTe neural emulator",
   x = "Timestep (14-day periods)",
   y = "Clinical Cases (per 1000)",
   color = "Scenario"
 ) +
 theme_minimal() +
 theme(legend.position = "right") +
 scale_color_viridis_d()
```

### Comparing Selected Scenarios

```{r plot-selected, fig.width=10, fig.height=5}
# Compare key scenarios
selected <- c("no_intervention", "irs_only", "py_pbo_only", "py_pyrrole_with_lsm")

res_multi$prevalence %>%
 filter(scenario_tag %in% selected) %>%
 ggplot(aes(x = timestep, y = prevalence, color = scenario_tag)) +
 geom_line(linewidth = 1.2) +
 labs(
   title = "Comparing Key Intervention Strategies",
   x = "Timestep (14-day periods)",
   y = "Prevalence",
   color = "Scenario"
 ) +
 theme_minimal() +
 theme(legend.position = "bottom") +
 scale_color_brewer(palette = "Set1")
```

### Bar Chart of Mean Prevalence

```{r plot-bar, fig.width=10, fig.height=5}
mean_prev %>%
 mutate(scenario_tag = reorder(scenario_tag, mean_prevalence)) %>%
 ggplot(aes(x = scenario_tag, y = mean_prevalence, fill = scenario_tag)) +
 geom_col() +
 coord_flip() +
 labs(
   title = "Mean Prevalence by Intervention Strategy",
   x = "Scenario",
   y = "Mean Prevalence"
 ) +
 theme_minimal() +
 theme(legend.position = "none") +
 scale_fill_viridis_d()
```

## 8. Using Built-in Plotting Functions

rminte also provides convenience plotting functions:

```{r builtin-plot, fig.width=10, fig.height=6}
# Using the built-in plot_prevalence function
plot_prevalence(res_multi, title = "Prevalence Trajectories")
```

```{r builtin-plot-cases, fig.width=10, fig.height=6}
# Using the built-in plot_cases function
plot_cases(res_multi, title = "Cases Trajectories")
```

## 9. Exporting Results

You can easily export results to CSV for further analysis:
```{r export, eval=FALSE}
# Export to CSV
write.csv(res_multi$prevalence, "prevalence_results.csv", row.names = FALSE)
write.csv(res_multi$cases, "cases_results.csv", row.names = FALSE)
write.csv(mean_prev, "mean_prevalence_summary.csv", row.names = FALSE)
```

## 10. Utility Functions

rminte provides several utility functions:

```{r utilities}
# Calculate net effectiveness from resistance
dn0_result <- calculate_overall_dn0(
 resistance_level = 0.3,
 py_only = 0.4,
 py_pbo = 0.3,
 py_pyrrole = 0.2,
 py_ppf = 0.1
)
cat("Calculated dn0:", dn0_result$dn0, "\n")
cat("Total ITN use:", dn0_result$itn_use, "\n")

# Get available net types
net_types <- available_net_types()
cat("Available net types:", paste(net_types, collapse = ", "), "\n")
```

## Summary

This vignette demonstrated how to:

1. **Run scenarios** using `run_minter_scenarios()` with various intervention parameters
2. **Access results** via the returned list (`$prevalence`, `$cases`, `$scenario_meta`)
3. **Analyze data** using dplyr for grouping and summarizing
4. **Visualize** with ggplot2 or built-in plotting functions
5. **Export** results to CSV for further analysis

The rminte package provides a seamless R interface to the Python MINTe neural emulator, allowing you to rapidly evaluate malaria intervention strategies without running full simulations.

## Session Info

```{r session-info}
sessionInfo()
```
